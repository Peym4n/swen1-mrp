image: maven:3.9-eclipse-temurin-23

services:
  - name: postgres:15-alpine
    alias: postgres

variables:
  # Postgres Service Configuration (Matches docker-compose.yaml)
  POSTGRES_DB: mrp_db
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: letmein
  POSTGRES_HOST_AUTH_METHOD: trust

  # Application Environment Variables
  DB_URL: jdbc:postgresql://postgres:5432/mrp_db
  DB_USER: postgres
  DB_PASSWORD: letmein
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: "" # Disable TLS so Docker listens on port 2375

stages:
  - build
  - lint
  - test
  - deploy

# Stage 1: Build
build_app:
  stage: build
  script:
    - mvn package -DskipTests
  artifacts:
    paths:
      - target/*.jar

# Stage 2: Static Analysis
static_analysis:
  stage: lint
  script:
    # Requires maven-checkstyle-plugin in pom.xml
    - mvn checkstyle:check

# Stage 3: Test
unit_tests:
  stage: test
  script:
    # Runs Unit & Integration tests using the 'postgres' service
    - mvn test

# Stage 4: Deploy
deploy_image:
  stage: deploy
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - apk add --no-cache git
    - echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
  script:
    - |
      if [[ "$CI_COMMIT_BRANCH" == "main" ]]; then
        TAG="latest"
      elif [[ "$CI_COMMIT_BRANCH" == "develop" ]]; then
        TAG="develop"
      else
        TAG="$CI_COMMIT_BRANCH"
      fi
    # 1. Build using the branch name
    - docker build -t $DOCKER_USER/swen1-mrp:$TAG .
    # 2. Add a second tag with the unique Commit SHA
    - docker tag $DOCKER_USER/swen1-mrp:$TAG $DOCKER_USER/swen1-mrp:$CI_COMMIT_SHORT_SHA
    # 3. Push BOTH
    - docker push $DOCKER_USER/swen1-mrp:$TAG
    - docker push $DOCKER_USER/swen1-mrp:$CI_COMMIT_SHORT_SHA
  only:
    - main
    - develop